<Project>
  <Target Name="GenerateDependenciesPropsFile" DependsOnTargets="Execute">
    <ItemGroup>
      <CommonlyImportedFiles Remove="@(CommonlyImportedFiles)" Condition="!Exists(%(CommonlyImportedFiles.Identity))" />
    </ItemGroup>

    <GenerateDependenciesPropsFile
      Projects="@(ProjectToBuild)"
      OtherImports="@(CommonlyImportedFiles)"
      DependenciesFile="$(VersionsPropsPath)"
      Properties="$(BuildProperties)" />
  </Target>

  <Target Name="GenerateProjectList">
    <MSBuild Projects="@(ProjectToBuild)"
             Targets="GetReferencesProvided"
             BuildInParallel="true"
             SkipNonexistentProjects="true" >

      <Output TaskParameter="TargetOutputs" ItemName="_ProjectReferenceProvider"/>
    </MSBuild>

    <PropertyGroup>
      <ProjectListFile>$(RepositoryEngineeringDir)\ProjectReferences.props</ProjectListFile>
      <ProjectListContent>
        <![CDATA[
<!--
    This file is automatically generated. Run `msbuild /t:GenerateProjectList` to update.
    This file contains a map of assembly names to the projects that build them.
-->
<Project>
    <ItemGroup>
        @(_ProjectReferenceProvider->'<ProjectReferenceProvider Include="%(Identity)" ProjectPath="%24(RepoRoot)\%(ProjectFileRelativePath)" />', '%0d%0A        ')
    </ItemGroup>
</Project>
      ]]>
      </ProjectListContent>
    </PropertyGroup>

    <WriteLinesToFile File="$(ProjectListFile)" Lines="$(ProjectListContent)" Overwrite="true" />
  </Target>

  <Target Name="GetReferencesProvided" Returns="@(ProvidesReference)">
    <ItemGroup>
      <_TargetFramework Remove="@(_TargetFramework)" />
      <_TargetFramework Include="$(TargetFramework)" Condition="'$(TargetFramework)' != '' "/>
      <_TargetFramework Include="$(TargetFrameworks)" Condition="'$(TargetFramework)' == '' "/>
    </ItemGroup>

    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="_GetReferencesProvided"
             Properties="TargetFramework=%(_TargetFramework.Identity)">
      <Output TaskParameter="TargetOutputs" ItemName="ProvidesReference" />
    </MSBuild>
  </Target>

  <Target Name="_GetReferencesProvided" Returns="@(ProvidesReference)">
    <ItemGroup Condition=" '$(IsProjectReferenceProvider)' == 'true' ">
      <ProvidesReference Include="$(AssemblyName)">
        <!--https://docs.microsoft.com/en-us/visualstudio/msbuild/property-functions?view=vs-2017#msbuild-makerelative-->
        <ProjectFileRelativePath>$([MSBuild]::MakeRelative($(RepoRoot), $(MSBuildProjectFullPath)))</ProjectFileRelativePath>
      </ProvidesReference>
    </ItemGroup>
  </Target>
</Project>
